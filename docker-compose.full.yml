version: '3.9'

################################################################################
# LightRAG Complete Stack with Databases
# Includes: PostgreSQL + pgvector, Neo4j, and LightRAG API
#
# This is the PRODUCTION setup with all dependencies
# Data is PERSISTENT even after container restart
################################################################################

services:
  # ============================================================================
  # PostgreSQL + pgvector
  # Armazena: Documentos, Cache LLM, Vectors (embeddings)
  # ============================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: lightrag-postgres

    environment:
      POSTGRES_DB: lightrag
      POSTGRES_USER: lightrag
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lightrag_secure_password_change_me}
      PGDATA: /var/lib/postgresql/data/pgdata

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    volumes:
      # Volume nomeado para dados (NUNCA PERDE)
      - postgres-data:/var/lib/postgresql/data
      # Scripts de inicialização (opcional)
      - ./init-postgres:/docker-entrypoint-initdb.d:ro

    networks:
      - lightrag-network

    restart: unless-stopped
    stop_grace_period: 30s

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lightrag -d lightrag"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

    # Performance tuning for production
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=16MB"

  # ============================================================================
  # Neo4j / DozerDB
  # Armazena: Entities (entidades) e Relationships (relações do KG)
  # ============================================================================
  neo4j:
    image: graphstack/dozerdb:5.26.3.0
    container_name: lightrag-neo4j

    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-neo4j_secure_password_change_me}
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_memory_heap_initial__size: 1G
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_dbms_memory_pagecache_size: 1G

    ports:
      - "${NEO4J_PORT:-7687}:7687"  # Bolt port
      - "${NEO4J_HTTP_PORT:-7474}:7474"  # HTTP port (opcional)

    volumes:
      # Volume nomeado para dados (NUNCA PERDE)
      - neo4j-data:/data
      - neo4j-logs:/logs

    networks:
      - lightrag-network

    restart: unless-stopped
    stop_grace_period: 30s

    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # LightRAG API
  # Conecta ao PostgreSQL e Neo4j
  # ============================================================================
  lightrag:
    # image: ghcr.io/hkuds/lightrag:latest  # Commented to force local build
    container_name: lightrag

    build:
      context: .
      dockerfile: Dockerfile
      tags:
        - ghcr.io/hkuds/lightrag:latest

    # Depende dos bancos de dados estarem prontos
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy

    environment:
      # LightRAG base config
      WORKING_DIR: /app/data/rag_storage
      INPUT_DIR: /app/data/inputs
      TIKTOKEN_CACHE_DIR: /app/data/tiktoken

      # PostgreSQL Connection
      POSTGRES_CONNECTION_STRING: postgresql://lightrag:${POSTGRES_PASSWORD:-lightrag_secure_password_change_me}@postgres:5432/lightrag

      # Neo4j Connection
      NEO4J_URI: neo4j://neo4j:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-neo4j_secure_password_change_me}

      # Storage engines configuration
      KV_STORAGE: PGKVStorage
      VECTOR_STORAGE: PGVectorStorage
      GRAPH_STORAGE: Neo4JStorage
      DOC_STATUS_STORAGE: PGDocStatusStorage

    ports:
      - "${PORT:-9621}:9621"

    volumes:
      # Volume nomeado para dados RAG (NUNCA PERDE)
      - lightrag-data:/app/data/rag_storage
      - lightrag-inputs:/app/data/inputs
      - lightrag-cache:/app/data/tiktoken
      # Configuração (leia-se)
      - ./config.ini:/app/config.ini:ro
      - ./.env:/app/.env:ro

    networks:
      - lightrag-network

    env_file:
      - .env

    restart: unless-stopped
    stop_grace_period: 30s

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9621/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service=lightrag"

################################################################################
# VOLUMES - Armazenam dados PERMANENTEMENTE
# Mesmo se container morrer, dados continuam aqui
################################################################################
volumes:
  # PostgreSQL data
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_MOUNT_PATH:-/opt/lightrag}/data/postgres

  # Neo4j data
  neo4j-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_MOUNT_PATH:-/opt/lightrag}/data/neo4j

  # Neo4j logs
  neo4j-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_MOUNT_PATH:-/opt/lightrag}/logs/neo4j

  # LightRAG storage
  lightrag-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_MOUNT_PATH:-/opt/lightrag}/data/rag_storage

  # LightRAG inputs
  lightrag-inputs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_MOUNT_PATH:-/opt/lightrag}/data/inputs

  # LightRAG cache
  lightrag-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_MOUNT_PATH:-/opt/lightrag}/data/tiktoken

################################################################################
# NETWORKS - Conecta os containers entre si
################################################################################
networks:
  lightrag-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
